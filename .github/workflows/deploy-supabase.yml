name: Deploy Supabase Functions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'GitHub Environment (optional). Set this if your secrets are scoped to an environment (e.g. "production").'
        required: false
        type: string
        default: ''
      project_ref_override:
        description: 'Supabase Project Ref Override (subdomain only). Use if secrets are missing.'
        required: false
        type: string
      dry_run:
        description: 'Dry Run: List functions instead of deploying. Safe for testing auth/config.'
        required: true
        default: true
        type: boolean

concurrency:
  group: supabase-functions-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Pre-flight Check
        run: npx tsx scripts/ci-preflight.ts --scope=supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Configuration
        shell: bash
        env:
          # Standard Keys
          REF_SECRET: ${{ secrets.SUPABASE_PROJECT_REF }}
          REF_VAR: ${{ vars.SUPABASE_PROJECT_REF }}
          # Compatibility Keys
          REF_SECRET_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          REF_VAR_ID: ${{ vars.SUPABASE_PROJECT_ID }}
          REF_SECRET_REF: ${{ secrets.SUPABASE_PROJECT_REFERENCE }}
          REF_VAR_REF: ${{ vars.SUPABASE_PROJECT_REFERENCE }}
          # Inputs
          REF_OVERRIDE: ${{ inputs.project_ref_override }}
          ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          echo "=== Configuration Validation ==="

          # 1. Check Access Token
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ CRITICAL: SUPABASE_ACCESS_TOKEN is missing."
            echo "   Action: Add 'SUPABASE_ACCESS_TOKEN' to Secrets."
            exit 1
          else
            echo "âœ… SUPABASE_ACCESS_TOKEN found (masked)."
          fi

          # 2. Resolve Project Ref
          REF=""
          SOURCE=""

          if [ -n "${REF_OVERRIDE:-}" ]; then
            REF="$REF_OVERRIDE"
            SOURCE="input:project_ref_override"
          elif [ -n "${REF_SECRET:-}" ]; then
            REF="$REF_SECRET"
            SOURCE="secret:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_VAR:-}" ]; then
            REF="$REF_VAR"
            SOURCE="var:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_SECRET_ID:-}" ]; then
            REF="$REF_SECRET_ID"
            SOURCE="secret:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_VAR_ID:-}" ]; then
            REF="$REF_VAR_ID"
            SOURCE="var:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_SECRET_REF:-}" ]; then
            REF="$REF_SECRET_REF"
            SOURCE="secret:SUPABASE_PROJECT_REFERENCE"
          elif [ -n "${REF_VAR_REF:-}" ]; then
            REF="$REF_VAR_REF"
            SOURCE="var:SUPABASE_PROJECT_REFERENCE"
          fi

          if [ -z "$REF" ]; then
            echo "âŒ CRITICAL: Supabase Project Ref is missing."
            echo "   Hypothesis H1: Secret name mismatch. Checked: SUPABASE_PROJECT_REF, SUPABASE_PROJECT_ID, SUPABASE_PROJECT_REFERENCE."
            echo "   Hypothesis H3: Secrets are Environment-scoped. Did you provide the 'environment' input?"
            echo "   Action: Set SUPABASE_PROJECT_REF in Secrets or Variables, or provide 'project_ref_override'."
            exit 1
          fi

          # 3. Clean & Validate Ref
          # Remove whitespace, newlines, quotes
          REF_CLEAN="$(echo -n "$REF" | tr -d '[:space:]\"'"'"' )"
          
          echo "â„¹ï¸  Ref Source: $SOURCE"
          echo "â„¹ï¸  Ref Length: ${#REF_CLEAN}"

          if ! echo "$REF_CLEAN" | grep -Eq '^[a-z0-9]{5,60}$'; then
            echo "âŒ INVALID FORMAT: Project Ref must be lowercase letters and digits (subdomain only)."
            echo "   Hypothesis H2: Value contains full URL or special characters."
            echo "   Value Preview (safe): $(echo "$REF_CLEAN" | cut -c1-3)..."
            exit 1
          fi

          echo "âœ… Project Ref validated: ${REF_CLEAN:0:4}***"
          echo "SUPABASE_PROJECT_REF=$REF_CLEAN" >> "$GITHUB_ENV"

      - name: Execute Supabase Command
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail
          
          # Ref is available from GITHUB_ENV as $SUPABASE_PROJECT_REF
          
          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸŸ¢ DRY RUN: Listing functions for project $SUPABASE_PROJECT_REF..."
            # 'functions list' validates auth and ref existence without deploying
            supabase functions list --project-ref "$SUPABASE_PROJECT_REF"
            echo "âœ… Dry run successful. Connection established."
          else
            echo "ï¿½ DEPLOYING functions to project $SUPABASE_PROJECT_REF..."
            supabase functions deploy --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt
            echo "âœ… Deployment successful."
          fi
