name: Deploy Supabase Functions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'GitHub Environment (optional). Use only if your secrets are scoped to an Environment (e.g. "production"). Leave blank otherwise.'
        required: false
        type: string
        default: ''
      project_ref_override:
        description: 'Supabase Project Ref Override (subdomain only). Use only if secrets/vars are missing.'
        required: false
        type: string
      dry_run:
        description: 'Dry Run: List functions instead of deploying (safe verification).'
        required: true
        default: true
        type: boolean

concurrency:
  group: supabase-functions-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy_no_env:
    name: Deploy (no environment)
    if: ${{ inputs.environment == '' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Pre-flight Check
        run: npx tsx scripts/ci-preflight.ts --scope=supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Configuration
        shell: bash
        env:
          # Standard Keys
          REF_SECRET: ${{ secrets.SUPABASE_PROJECT_REF }}
          REF_VAR: ${{ vars.SUPABASE_PROJECT_REF }}
          # Compatibility Keys
          REF_SECRET_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          REF_VAR_ID: ${{ vars.SUPABASE_PROJECT_ID }}
          REF_SECRET_REF: ${{ secrets.SUPABASE_PROJECT_REFERENCE }}
          REF_VAR_REF: ${{ vars.SUPABASE_PROJECT_REFERENCE }}
          # Inputs
          REF_OVERRIDE: ${{ inputs.project_ref_override }}
          ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          echo "=== Configuration Validation ==="

          # H5: Missing token
          if [ -z "${ACCESS_TOKEN:-}" ]; then
            echo "‚ùå CRITICAL: SUPABASE_ACCESS_TOKEN is missing."
            echo "   Action: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Secrets ‚Üí add SUPABASE_ACCESS_TOKEN"
            exit 1
          fi
          echo "‚úÖ SUPABASE_ACCESS_TOKEN found (masked)."

          # Resolve project ref
          REF=""
          SOURCE=""

          if [ -n "${REF_OVERRIDE:-}" ]; then
            REF="$REF_OVERRIDE"
            SOURCE="input:project_ref_override"
          elif [ -n "${REF_SECRET:-}" ]; then
            REF="$REF_SECRET"
            SOURCE="secret:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_VAR:-}" ]; then
            REF="$REF_VAR"
            SOURCE="var:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_SECRET_ID:-}" ]; then
            REF="$REF_SECRET_ID"
            SOURCE="secret:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_VAR_ID:-}" ]; then
            REF="$REF_VAR_ID"
            SOURCE="var:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_SECRET_REF:-}" ]; then
            REF="$REF_SECRET_REF"
            SOURCE="secret:SUPABASE_PROJECT_REFERENCE"
          elif [ -n "${REF_VAR_REF:-}" ]; then
            REF="$REF_VAR_REF"
            SOURCE="var:SUPABASE_PROJECT_REFERENCE"
          fi

          # 3. Fallback: Parse supabase/config.toml
          if [ -z "${REF:-}" ] && [ -f "supabase/config.toml" ]; then
             echo "‚ÑπÔ∏è  Attempting to read project_id from supabase/config.toml..."
             REF_TOML=$(grep -E '^project_id\s*=' supabase/config.toml | sed -E 's/^project_id\s*=\s*"([^"]+)".*/\1/')
             if [ -n "$REF_TOML" ]; then
               REF="$REF_TOML"
               SOURCE="file:supabase/config.toml"
             fi
          fi

          if [ -z "${REF:-}" ]; then
            echo "‚ùå CRITICAL: Supabase Project Ref is missing."
            echo "   H1: Secret/Var name mismatch (checked SUPABASE_PROJECT_REF / _ID / _REFERENCE)."
            echo "   H6: supabase/config.toml missing or invalid."
            echo "   Action: Add SUPABASE_PROJECT_REF (recommended) as Secret or Variable."
            echo "   Or run workflow with project_ref_override."
            exit 1
          fi

          # Clean: remove CR/LF, trim leading/trailing spaces, strip surrounding quotes
          REF_CLEAN="$(printf '%s' "$REF" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' )"
          REF_CLEAN="$(printf '%s' "$REF_CLEAN" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")"

          LEN="${#REF_CLEAN}"
          echo "‚ÑπÔ∏è  Ref Source: $SOURCE"
          echo "‚ÑπÔ∏è  Ref Length: $LEN"

          # H2: Full URL / special chars / uppercase
          if ! printf '%s' "$REF_CLEAN" | grep -Eq '^[a-z0-9]{5,60}$'; then
            echo "‚ùå INVALID FORMAT: Project Ref must be ONLY the subdomain part from https://<REF>.supabase.co"
            echo "   Expected pattern: lowercase letters + digits only."
            echo "   Action: Fix SUPABASE_PROJECT_REF value (do NOT paste full URL)."
            exit 1
          fi

          echo "‚úÖ Project Ref validated (masked)."
          echo "SUPABASE_PROJECT_REF=$REF_CLEAN" >> "$GITHUB_ENV"

      - name: Execute Supabase Command
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail

          if [ "${DRY_RUN}" = "true" ]; then
            echo "üü¢ DRY RUN: Listing functions (no deploy)."
            supabase functions list --project-ref "$SUPABASE_PROJECT_REF"
            echo "‚úÖ Dry run successful."
          else
            echo "üî¥ DEPLOY: Deploying functions."
            supabase functions deploy --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt
            echo "‚úÖ Deployment finished."
          fi

  deploy_with_env:
    name: Deploy (with environment)
    if: ${{ inputs.environment != '' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Pre-flight Check
        run: npx tsx scripts/ci-preflight.ts --scope=supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate Configuration
        shell: bash
        env:
          # Standard Keys
          REF_SECRET: ${{ secrets.SUPABASE_PROJECT_REF }}
          REF_VAR: ${{ vars.SUPABASE_PROJECT_REF }}
          # Compatibility Keys
          REF_SECRET_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          REF_VAR_ID: ${{ vars.SUPABASE_PROJECT_ID }}
          REF_SECRET_REF: ${{ secrets.SUPABASE_PROJECT_REFERENCE }}
          REF_VAR_REF: ${{ vars.SUPABASE_PROJECT_REFERENCE }}
          # Inputs
          REF_OVERRIDE: ${{ inputs.project_ref_override }}
          ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail

          echo "=== Configuration Validation ==="
          echo "‚ÑπÔ∏è  Using GitHub Environment: '${{ inputs.environment }}'"

          if [ -z "${ACCESS_TOKEN:-}" ]; then
            echo "‚ùå CRITICAL: SUPABASE_ACCESS_TOKEN is missing."
            echo "   H4: Secrets may be scoped to a different Environment name."
            echo "   Action: ensure SUPABASE_ACCESS_TOKEN exists in this Environment or as repo secret."
            exit 1
          fi
          echo "‚úÖ SUPABASE_ACCESS_TOKEN found (masked)."

          REF=""
          SOURCE=""

          if [ -n "${REF_OVERRIDE:-}" ]; then
            REF="$REF_OVERRIDE"
            SOURCE="input:project_ref_override"
          elif [ -n "${REF_SECRET:-}" ]; then
            REF="$REF_SECRET"
            SOURCE="secret:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_VAR:-}" ]; then
            REF="$REF_VAR"
            SOURCE="var:SUPABASE_PROJECT_REF"
          elif [ -n "${REF_SECRET_ID:-}" ]; then
            REF="$REF_SECRET_ID"
            SOURCE="secret:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_VAR_ID:-}" ]; then
            REF="$REF_VAR_ID"
            SOURCE="var:SUPABASE_PROJECT_ID"
          elif [ -n "${REF_SECRET_REF:-}" ]; then
            REF="$REF_SECRET_REF"
            SOURCE="secret:SUPABASE_PROJECT_REFERENCE"
          elif [ -n "${REF_VAR_REF:-}" ]; then
            REF="$REF_VAR_REF"
            SOURCE="var:SUPABASE_PROJECT_REFERENCE"
          fi

          if [ -z "${REF:-}" ]; then
            echo "‚ùå CRITICAL: Supabase Project Ref is missing."
            echo "   H4 likely: wrong Environment input or secrets not defined for that Environment."
            echo "   Action: confirm secrets exist in Environment '${{ inputs.environment }}' OR set repo-level SUPABASE_PROJECT_REF."
            exit 1
          fi

          REF_CLEAN="$(printf '%s' "$REF" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' )"
          REF_CLEAN="$(printf '%s' "$REF_CLEAN" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")"

          LEN="${#REF_CLEAN}"
          echo "‚ÑπÔ∏è  Ref Source: $SOURCE"
          echo "‚ÑπÔ∏è  Ref Length: $LEN"

          if ! printf '%s' "$REF_CLEAN" | grep -Eq '^[a-z0-9]{5,60}$'; then
            echo "‚ùå INVALID FORMAT: Project Ref must be ONLY the subdomain part from https://<REF>.supabase.co"
            exit 1
          fi

          echo "‚úÖ Project Ref validated (masked)."
          echo "SUPABASE_PROJECT_REF=$REF_CLEAN" >> "$GITHUB_ENV"

      - name: Execute Supabase Command
        shell: bash
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail

          if [ "${DRY_RUN}" = "true" ]; then
            echo "üü¢ DRY RUN: Listing functions (no deploy)."
            supabase functions list --project-ref "$SUPABASE_PROJECT_REF"
            echo "‚úÖ Dry run successful."
          else
            echo "üî¥ DEPLOY: Deploying functions."
            supabase functions deploy --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt
            echo "‚úÖ Deployment finished."
          fi

# git push
